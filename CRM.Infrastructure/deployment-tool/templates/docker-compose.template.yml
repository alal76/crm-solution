# CRM Solution - Docker Compose Template
# Generated by Deployment Tool
# Version: 0.0.24

version: '3.8'

services:
  # Database Service
  database:
    image: mariadb:11
    container_name: crm-database
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-crm_root_pass}
      MARIADB_DATABASE: crm_db
      MARIADB_USER: crm_user
      MARIADB_PASSWORD: ${DB_PASSWORD:-crm_pass}
    volumes:
      - db_data:/var/lib/mysql
      - ./init-scripts:/docker-entrypoint-initdb.d
    ports:
      - "${DB_PORT:-3306}:3306"
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - crm-network

  # Backend API Service
  api:
    image: crm-solution/api:${VERSION:-0.0.24}
    build:
      context: ../../CRM.Backend
      dockerfile: ../docker/Dockerfile.backend
    container_name: crm-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Server=database;Port=3306;Database=crm_db;User=crm_user;Password=${DB_PASSWORD:-crm_pass}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ISSUER=CRM-Solution
      - JWT_AUDIENCE=CRM-Solution-API
      - ADMIN_USERNAME=${ADMIN_USERNAME:-sysadmin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-Password@123}
    ports:
      - "${API_PORT:-5000}:5000"
    depends_on:
      database:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - crm-network

  # Frontend Service
  frontend:
    image: crm-solution/frontend:${VERSION:-0.0.24}
    build:
      context: ../../CRM.Frontend
      dockerfile: ../docker/Dockerfile.frontend
    container_name: crm-frontend
    restart: unless-stopped
    environment:
      - REACT_APP_API_URL=http://${DOMAIN:-localhost}:${API_PORT:-5000}
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      - api
    networks:
      - crm-network

volumes:
  db_data:
    driver: local

networks:
  crm-network:
    driver: bridge
