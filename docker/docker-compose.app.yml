# Docker Compose for CRM Application (Frontend + API)
# Connects to databases running in docker-compose.databases.yml
#
# Usage:
#   docker compose -f docker-compose.app.yml up -d
#
# Prerequisites:
#   - Databases must be running: docker compose -f docker-compose.databases.yml up -d

volumes:
  api-data:
    driver: local

networks:
  crm-database-network:
    external: true
    name: crm-database-network

services:
  # ============================================
  # CRM API (Backend)
  # ============================================
  api:
    image: ${API_IMAGE:-crm-api:latest}
    container_name: crm-api
    restart: unless-stopped
    ports:
      - "${API_EXTERNAL_PORT:-5000}:5000"
    environment:
      # Application Environment
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Production}
      ASPNETCORE_URLS: http://+:5000
      
      # Allow all hosts (for health checks and external access)
      AllowedHosts: "*"
      
      # Database Configuration (MariaDB by default)
      DatabaseProvider: ${DATABASE_PROVIDER:-mariadb}
      DB_HOST: ${DB_HOST:-crm-mariadb}
      DB_PORT: ${DB_PORT:-3306}
      DB_NAME: ${DB_NAME:-crm_db}
      DB_USER: ${DB_USER:-crm_user}
      DB_PASSWORD: ${DB_PASSWORD:-CrmPass@Dev2024!}
      
      # Connection String (auto-generated if not provided)
      ConnectionStrings__DefaultConnection: "Server=${DB_HOST:-crm-mariadb};Port=${DB_PORT:-3306};Database=${DB_NAME:-crm_db};User=${DB_USER:-crm_user};Password=${DB_PASSWORD:-CrmPass@Dev2024!};"
      
      # JWT Configuration
      Jwt__Secret: ${JWT_SECRET:-CrmJwtSecretKey2024!@ForSecureAuthentication}
      Jwt__Issuer: ${JWT_ISSUER:-CRMApp}
      Jwt__Audience: ${JWT_AUDIENCE:-CRMUsers}
      Jwt__ExpirationMinutes: ${JWT_EXPIRATION:-15}
      
      # Demo Database (auto-seeded)
      DemoDatabase__AutoSeed: "true"
      DemoDatabase__DatabaseName: "crm_demodb"
      
      # Contract Storage
      CONTRACT_STORAGE_PATH: /app/data/contracts
      MAX_CONTRACT_FILE_SIZE_BYTES: "10485760"
    volumes:
      - api-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - crm-database-network
    labels:
      - "com.crm.service.type=api"
      - "com.crm.service.port=5000"

  # ============================================
  # CRM Frontend (React)
  # ============================================
  frontend:
    image: ${FRONTEND_IMAGE:-crm-frontend:latest}
    container_name: crm-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_EXTERNAL_PORT:-80}:80"
    environment:
      NODE_ENV: production
      REACT_APP_API_URL: ${REACT_APP_API_URL:-http://192.168.0.9:5000/api}
    depends_on:
      api:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - crm-database-network
    labels:
      - "com.crm.service.type=frontend"
      - "com.crm.service.port=80"
