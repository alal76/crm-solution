# Docker Compose for CRM Solution with SQL Server Database
# Use: docker-compose -f docker-compose.sqlserver.yml up -d
# For deployment to 192.168.0.9 with Kubernetes frontend/backend + Docker SQL Server

version: '3.8'

services:
  # Database Tier - SQL Server
  sqlserver:
    image: mcr.microsoft.com/mssql/server:${MSSQL_VERSION:-2022-latest}
    container_name: crm-sqlserver
    ports:
      - "${DB_EXTERNAL_PORT:-1433}:1433"
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SA_PASSWORD:-CrmPass@Dev2024!}
      - MSSQL_PID=${MSSQL_EDITION:-Express}
      - MSSQL_COLLATION=${MSSQL_COLLATION:-SQL_Latin1_General_CP1_CI_AS}
    volumes:
      - sqlserver-data:/var/opt/mssql
      - ./init-scripts/sqlserver:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "${MSSQL_TOOLS_PATH:-/opt/mssql-tools18/bin}/sqlcmd -S localhost -U sa -P '${SA_PASSWORD:-CrmPass@Dev2024!}' -Q 'SELECT 1' -C || exit 1"]
      interval: ${MSSQL_HEALTH_INTERVAL:-30s}
      timeout: ${MSSQL_HEALTH_TIMEOUT:-10s}
      retries: ${MSSQL_HEALTH_RETRIES:-5}
      start_period: ${MSSQL_START_PERIOD:-60s}
    networks:
      - crm-network
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: crm-redis
    ports:
      - "${REDIS_EXTERNAL_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-network
    restart: unless-stopped

volumes:
  sqlserver-data:
    driver: local
  redis-data:
    driver: local

networks:
  crm-network:
    driver: bridge
