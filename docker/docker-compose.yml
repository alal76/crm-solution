volumes:
  db-data:
  api-data:
  redis-data:
services:
  # Database Tier (MariaDB - Hosts both production and demo databases)
  mariadb:
    image: mariadb:latest
    container_name: crm-mariadb
    ports:
      - "${DB_EXTERNAL_PORT:-3306}:3306"
    environment:
      - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-RootPass@Dev2024}
      - MARIADB_DATABASE=${DB_NAME:-crm_db}
      - MARIADB_USER=${DB_USER:-crm_user}
      - MARIADB_PASSWORD=${DB_PASSWORD:-CrmPass@Dev2024}
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - crm-network

  # Redis Cache (Distributed Caching)
  redis:
    image: redis:7-alpine
    container_name: crm-redis
    ports:
      - "${REDIS_EXTERNAL_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - crm-network

  # API Tier (Application/Business Logic)
  api:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: crm-api:latest
    container_name: crm-api
    ports:
      - "${API_EXTERNAL_PORT:-5000}:5000"
    env_file:
      - .env
    environment:
      - DatabaseProvider=${DATABASE_PROVIDER:-mariadb}
      - DB_HOST=${DB_HOST:-mariadb}
      - DB_PORT=${DB_INTERNAL_PORT:-3306}
      - DB_NAME=${DB_NAME:-crm_db}
      - DB_USER=${DB_USER:-crm_user}
      - DB_PASSWORD=${DB_PASSWORD}
      # Default connection string for production database
      - ConnectionStrings__DefaultConnection=Server=${DB_HOST:-mariadb};Port=${DB_PORT:-3306};Database=${DB_NAME:-crm_db};User=${DB_USER:-crm_user};Password=${DB_PASSWORD:-CrmPass@Dev2024};
      # Demo database (crm_demodb) is auto-created on same server
      - DemoDatabase__AutoSeed=${DEMO_AUTO_SEED:-true}
      - DemoDatabase__DatabaseName=${DEMO_DB_NAME:-crm_demodb}
      - API_EXTERNAL_PORT=${API_EXTERNAL_PORT:-5000}
      - API_INTERNAL_PORT=${API_INTERNAL_PORT:-5000}
      - Jwt__ExpirationMinutes=${JWT_EXPIRATION_MINUTES:-15}
      - Jwt__Secret=${JWT_SECRET:-CrmJwtSecretKey2024ForSecureAuthentication}
      # Contract storage configuration
      - CONTRACT_STORAGE_PATH=${CONTRACT_STORAGE_PATH:-/app/data/contracts}
      - MAX_CONTRACT_FILE_SIZE_BYTES=${MAX_CONTRACT_FILE_SIZE:-10485760}
      - ALLOWED_CONTRACT_MIME_TYPES=${ALLOWED_MIME_TYPES:-application/pdf,image/png,image/jpeg,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document}
      # Redis cache configuration
      - Redis__ConnectionString=${REDIS_HOST:-redis}:${REDIS_PORT:-6379}
      - Redis__InstanceName=${REDIS_INSTANCE:-crm_}
      - Redis__Enabled=${REDIS_ENABLED:-true}
      # Monitoring configuration
      - Monitoring__DeploymentType=${DEPLOYMENT_TYPE:-docker}
      - Monitoring__BuildServer=${BUILD_SERVER:-localhost}
      - Monitoring__BuildServerFQDN=${BUILD_SERVER_FQDN:-}
      - Monitoring__EnableDockerMonitoring=${ENABLE_DOCKER_MONITORING:-true}
      - Monitoring__EnableK8sMonitoring=${ENABLE_K8S_MONITORING:-false}
      - Monitoring__DatabaseProvider=${DATABASE_PROVIDER:-mariadb}
      - Frontend__Url=${FRONTEND_URL:-http://localhost}
    volumes:
      - api-data:/app/data
    depends_on:
      - mariadb
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - crm-network

  # Frontend Tier (Presentation)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        BUILD_DATE: "2026-01-20T12:00:00Z"
        REACT_APP_API_URL: ${REACT_APP_API_URL}
        REACT_APP_API_PORT: ${API_INTERNAL_PORT:-5000}
        REACT_APP_API_EXTERNAL_PORT: ${API_EXTERNAL_PORT:-5000}
        REACT_APP_DB_PORT: ${DB_INTERNAL_PORT:-3306}
        REACT_APP_FRONTEND_PORT: ${FRONTEND_EXTERNAL_PORT:-80}
    # image: crm-frontend:latest
    container_name: crm-frontend
    ports:
      - "${FRONTEND_EXTERNAL_PORT:-80}:80"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
    depends_on:
      - api
    networks:
      - crm-network

networks:
  crm-network:
    driver: bridge
