# =============================================================================
# CRM Solution - Unified Docker Compose (Monolith Architecture)
# =============================================================================
# This file uses the master naming convention from config/infrastructure.env
#
# Usage:
#   # Set environment and run
#   export $(cat config/infrastructure.env | grep -v '^#' | grep -v '^$' | xargs)
#   docker compose -f docker/docker-compose.unified.yml up -d
#
# Or with env_file:
#   docker compose --env-file config/infrastructure.env -f docker/docker-compose.unified.yml up -d
#
# Services:
#   - crm-mariadb: Database (MariaDB)
#   - crm-redis: Cache (Redis)
#   - crm-api: Backend API (.NET 8)
#   - crm-frontend: Frontend (React/Nginx)
# =============================================================================

# Named volumes for persistent data
volumes:
  crm_db_data:
    driver: local
    name: crm_db_data
  crm_api_data:
    driver: local
    name: crm_api_data
  crm_redis_data:
    driver: local
    name: crm_redis_data

# Networks - using explicit name for DNS consistency
networks:
  crm-network:
    driver: bridge
    name: crm-network
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

services:
  # ===========================================================================
  # TIER 0: DATABASE SERVICES (No Dependencies)
  # ===========================================================================
  
  crm-mariadb:
    image: ${IMAGE_MARIADB:-mariadb:latest}
    container_name: ${CONTAINER_MARIADB:-crm-mariadb}
    hostname: crm-mariadb
    restart: unless-stopped
    ports:
      - "${PORT_MARIADB_EXTERNAL:-3306}:3306"
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-RootPass@Dev2024}
      MARIADB_DATABASE: ${DB_NAME:-crm_db}
      MARIADB_USER: ${DB_USER:-crm_user}
      MARIADB_PASSWORD: ${DB_PASSWORD:-CrmPass@Dev2024}
    volumes:
      - crm_db_data:/var/lib/mysql
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-RootPass@Dev2024}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      crm-network:
        aliases:
          - crm-mariadb
          - mariadb
          - db
    labels:
      - "com.crm.tier=database"
      - "com.crm.service=mariadb"

  crm-redis:
    image: ${IMAGE_REDIS:-redis:7-alpine}
    container_name: ${CONTAINER_REDIS:-crm-redis}
    hostname: crm-redis
    restart: unless-stopped
    ports:
      - "${PORT_REDIS_EXTERNAL:-6379}:6379"
    volumes:
      - crm_redis_data:/data
    command: redis-server --appendonly yes --maxmemory ${REDIS_MAX_MEMORY:-256mb} --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      crm-network:
        aliases:
          - crm-redis
          - redis
          - cache
    labels:
      - "com.crm.tier=cache"
      - "com.crm.service=redis"

  # ===========================================================================
  # TIER 1: APPLICATION SERVICES (Depends on Database & Cache)
  # ===========================================================================

  crm-api:
    image: ${IMAGE_API:-crm-api}:${API_VERSION:-latest}
    container_name: ${CONTAINER_API:-crm-api}
    hostname: crm-api
    restart: unless-stopped
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
      args:
        DOTNET_VERSION: ${DOTNET_VERSION:-8.0}
    ports:
      - "${PORT_API_EXTERNAL:-5000}:5000"
    environment:
      # ASP.NET Core
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Production}
      ASPNETCORE_URLS: http://+:5000
      AllowedHosts: "*"
      
      # Database - use container hostname with network alias
      DatabaseProvider: ${DATABASE_PROVIDER:-mariadb}
      DB_HOST: crm-mariadb
      DB_PORT: ${PORT_MARIADB_INTERNAL:-3306}
      DB_NAME: ${DB_NAME:-crm_db}
      DB_USER: ${DB_USER:-crm_user}
      DB_PASSWORD: ${DB_PASSWORD:-CrmPass@Dev2024}
      ConnectionStrings__DefaultConnection: Server=crm-mariadb;Port=3306;Database=${DB_NAME:-crm_db};User=${DB_USER:-crm_user};Password=${DB_PASSWORD:-CrmPass@Dev2024};
      
      # Demo Database
      DemoDatabase__AutoSeed: ${DEMO_AUTO_SEED:-true}
      DemoDatabase__DatabaseName: ${DEMO_DB_NAME:-crm_demodb}
      
      # Redis Cache - use container hostname
      Redis__ConnectionString: crm-redis:6379
      Redis__InstanceName: ${REDIS_INSTANCE_NAME:-crm_}
      Redis__Enabled: ${REDIS_ENABLED:-true}
      
      # JWT
      Jwt__Secret: ${JWT_SECRET:-CrmJwtSecretKey2024ForSecureAuthentication}
      Jwt__Issuer: ${JWT_ISSUER:-CRMApp}
      Jwt__Audience: ${JWT_AUDIENCE:-CRMUsers}
      Jwt__ExpirationMinutes: ${JWT_EXPIRATION_MINUTES:-15}
      
      # LLM (Ollama)
      LLMProviders__DefaultProvider: ${LLM_PROVIDER:-local}
      LLMProviders__LocalLLM__Enabled: "true"
      LLMProviders__LocalLLM__BaseUrl: ${LLM_BASE_URL:-http://host.docker.internal:11434}
      LLMProviders__LocalLLM__DefaultModel: ${LLM_DEFAULT_MODEL:-qwen2.5:0.5b}
      LLMProviders__LocalLLM__ApiFormat: ${LLM_API_FORMAT:-ollama}
      
      # File Storage
      CONTRACT_STORAGE_PATH: ${CONTRACT_STORAGE_PATH:-/app/data/contracts}
      MAX_CONTRACT_FILE_SIZE_BYTES: ${MAX_CONTRACT_FILE_SIZE:-10485760}
      ALLOWED_CONTRACT_MIME_TYPES: ${ALLOWED_MIME_TYPES:-application/pdf,image/png,image/jpeg,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document}
      
      # Frontend URL for CORS
      Frontend__Url: ${FRONTEND_URL:-http://localhost}
      
      # Monitoring
      Monitoring__DeploymentType: ${DEPLOYMENT_TYPE:-docker}
      Monitoring__EnableDockerMonitoring: ${ENABLE_DOCKER_MONITORING:-true}
      Monitoring__EnableK8sMonitoring: ${ENABLE_K8S_MONITORING:-false}
    volumes:
      - crm_api_data:/app/data
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      crm-mariadb:
        condition: service_healthy
      crm-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      crm-network:
        aliases:
          - crm-api
          - api
          - backend
    labels:
      - "com.crm.tier=application"
      - "com.crm.service=api"
      - "com.crm.port=5000"

  # ===========================================================================
  # TIER 2: PRESENTATION SERVICES (Depends on API)
  # ===========================================================================

  crm-frontend:
    image: ${IMAGE_FRONTEND:-crm-frontend}:${FRONTEND_VERSION:-latest}
    container_name: ${CONTAINER_FRONTEND:-crm-frontend}
    hostname: crm-frontend
    restart: unless-stopped
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
      args:
        NODE_VERSION: ${NODE_VERSION:-20}
    ports:
      - "${PORT_FRONTEND_EXTERNAL:-80}:80"
    environment:
      # API endpoint for nginx proxy
      API_URL: http://crm-api:5000
      # Browser-accessible API URL
      REACT_APP_API_URL: ${FRONTEND_API_URL:-http://localhost:5000}
    depends_on:
      crm-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health.html"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      crm-network:
        aliases:
          - crm-frontend
          - frontend
          - web
    labels:
      - "com.crm.tier=presentation"
      - "com.crm.service=frontend"
      - "com.crm.port=80"
