# =============================================================================
# CRM Solution - Master Infrastructure Configuration
# =============================================================================
# This file defines ALL naming conventions and configuration for the CRM
# infrastructure. ALL build scripts, Docker Compose files, and Kubernetes
# manifests should reference these values to ensure consistency.
#
# Usage:
#   source config/infrastructure.env
#   Or: export $(cat config/infrastructure.env | grep -v '^#' | xargs)
#
# Last Updated: 2026-01-29
# =============================================================================

# -----------------------------------------------------------------------------
# PROJECT IDENTIFIERS
# -----------------------------------------------------------------------------
PROJECT_NAME=crm
PROJECT_NAMESPACE=crm-app
PROJECT_DISPLAY_NAME="CRM Solution"

# -----------------------------------------------------------------------------
# ARCHITECTURE MODE: monolith | microservices
# -----------------------------------------------------------------------------
ARCHITECTURE_MODE=${ARCHITECTURE_MODE:-monolith}

# -----------------------------------------------------------------------------
# DEPLOYMENT TARGETS
# -----------------------------------------------------------------------------
# Supported: local | dev | staging | production
DEPLOYMENT_ENV=${DEPLOYMENT_ENV:-local}

# Build/Deploy Server Configuration
BUILD_SERVER_LOCAL=localhost
BUILD_SERVER_DEV=192.168.0.9
BUILD_SERVER_STAGING=staging.crm.local
BUILD_SERVER_PRODUCTION=prod.crm.local

# Active build server (set by environment)
BUILD_SERVER=${BUILD_SERVER:-${BUILD_SERVER_DEV}}
BUILD_USER=${BUILD_USER:-root}

# -----------------------------------------------------------------------------
# NETWORK CONFIGURATION
# -----------------------------------------------------------------------------
# Docker Network Names (consistent across all compose files)
DOCKER_NETWORK_NAME=crm-network
DOCKER_DATABASE_NETWORK=crm-database-network
DOCKER_FRONTEND_NETWORK=crm-frontend-network

# Kubernetes Network
K8S_NETWORK_POLICY_NAME=crm-network-policy

# -----------------------------------------------------------------------------
# CONTAINER/POD NAMING CONVENTION
# Format: {project}-{service}[-{instance}]
# Examples: crm-api, crm-frontend, crm-mariadb, crm-redis
# -----------------------------------------------------------------------------

# === MONOLITH ARCHITECTURE ===
# Database Services
CONTAINER_MARIADB=crm-mariadb
CONTAINER_MSSQL=crm-mssql
CONTAINER_REDIS=crm-redis

# Application Services
CONTAINER_API=crm-api
CONTAINER_FRONTEND=crm-frontend

# === MICROSERVICES ARCHITECTURE ===
# Shared Services
MS_CONTAINER_DB=crm-db
MS_CONTAINER_REDIS=crm-redis
MS_CONTAINER_GATEWAY=crm-gateway

# Microservices
MS_CONTAINER_IDENTITY=crm-identity
MS_CONTAINER_CUSTOMER=crm-customer
MS_CONTAINER_SALES=crm-sales
MS_CONTAINER_MARKETING=crm-marketing
MS_CONTAINER_SERVICEDESK=crm-servicedesk
MS_CONTAINER_CORE=crm-core
MS_CONTAINER_FRONTEND=crm-frontend

# -----------------------------------------------------------------------------
# IMAGE NAMING CONVENTION
# Format: {registry}/{project}-{service}:{version}
# -----------------------------------------------------------------------------
IMAGE_REGISTRY=${IMAGE_REGISTRY:-localhost:5000}

# Monolith Images
IMAGE_API=${IMAGE_REGISTRY}/crm-api
IMAGE_FRONTEND=${IMAGE_REGISTRY}/crm-frontend

# Microservices Images
IMAGE_GATEWAY=${IMAGE_REGISTRY}/crm-gateway
IMAGE_IDENTITY=${IMAGE_REGISTRY}/crm-identity
IMAGE_CUSTOMER=${IMAGE_REGISTRY}/crm-customer
IMAGE_SALES=${IMAGE_REGISTRY}/crm-sales
IMAGE_MARKETING=${IMAGE_REGISTRY}/crm-marketing
IMAGE_SERVICEDESK=${IMAGE_REGISTRY}/crm-servicedesk
IMAGE_CORE=${IMAGE_REGISTRY}/crm-core

# Database Images (official)
IMAGE_MARIADB=mariadb:latest
IMAGE_MSSQL=mcr.microsoft.com/mssql/server:2022-latest
IMAGE_REDIS=redis:7-alpine

# -----------------------------------------------------------------------------
# PORT ALLOCATION
# Pattern: Service gets a consistent internal port, external ports vary by env
# -----------------------------------------------------------------------------

# Database Ports
PORT_MARIADB_INTERNAL=3306
PORT_MARIADB_EXTERNAL=${PORT_MARIADB_EXTERNAL:-3306}
PORT_MSSQL_INTERNAL=1433
PORT_MSSQL_EXTERNAL=${PORT_MSSQL_EXTERNAL:-1433}
PORT_REDIS_INTERNAL=6379
PORT_REDIS_EXTERNAL=${PORT_REDIS_EXTERNAL:-6379}

# Monolith API Ports
PORT_API_INTERNAL=5000
PORT_API_EXTERNAL=${PORT_API_EXTERNAL:-5000}

# Frontend Ports
PORT_FRONTEND_INTERNAL=80
PORT_FRONTEND_EXTERNAL=${PORT_FRONTEND_EXTERNAL:-80}

# Microservices Ports (internal)
PORT_GATEWAY=5000
PORT_IDENTITY=5001
PORT_CUSTOMER=5002
PORT_SALES=5003
PORT_MARKETING=5004
PORT_SERVICEDESK=5005
PORT_CORE=5006

# SignalR/WebSocket
PORT_SIGNALR=${PORT_API_INTERNAL}
SIGNALR_HUB_PATH=/hubs/notifications

# -----------------------------------------------------------------------------
# DATABASE CONFIGURATION
# -----------------------------------------------------------------------------
DATABASE_PROVIDER=${DATABASE_PROVIDER:-mariadb}

# MariaDB Configuration
DB_HOST=${CONTAINER_MARIADB}
DB_PORT=${PORT_MARIADB_INTERNAL}
DB_NAME=crm_db
DB_USER=crm_user
DB_PASSWORD=${DB_PASSWORD:-CrmPass@Dev2024}
DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-RootPass@Dev2024}

# Demo Database (same server)
DEMO_DB_NAME=crm_demodb
DEMO_AUTO_SEED=true

# SQL Server Configuration (alternative)
MSSQL_HOST=${CONTAINER_MSSQL}
MSSQL_PORT=${PORT_MSSQL_INTERNAL}
MSSQL_SA_PASSWORD=${MSSQL_SA_PASSWORD:-CrmPass@Dev2024!}

# Connection String Templates
MARIADB_CONNECTION_STRING="Server=${DB_HOST};Port=${DB_PORT};Database=${DB_NAME};User=${DB_USER};Password=${DB_PASSWORD};"
MSSQL_CONNECTION_STRING="Server=${MSSQL_HOST};Database=${DB_NAME};User Id=${DB_USER};Password=${MSSQL_SA_PASSWORD};TrustServerCertificate=True;"

# -----------------------------------------------------------------------------
# REDIS CONFIGURATION
# -----------------------------------------------------------------------------
REDIS_HOST=${CONTAINER_REDIS}
REDIS_PORT=${PORT_REDIS_INTERNAL}
REDIS_INSTANCE_NAME=crm_
REDIS_ENABLED=true
REDIS_MAX_MEMORY=256mb
REDIS_CONNECTION_STRING="${REDIS_HOST}:${REDIS_PORT}"

# -----------------------------------------------------------------------------
# HEALTH CHECK CONFIGURATION
# -----------------------------------------------------------------------------
# All services use consistent health check patterns

# Database Health Checks
HEALTHCHECK_MARIADB_CMD='["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]'
HEALTHCHECK_MSSQL_CMD='["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "${MSSQL_SA_PASSWORD}", "-Q", "SELECT 1"]'
HEALTHCHECK_REDIS_CMD='["CMD", "redis-cli", "ping"]'

# Application Health Checks
HEALTHCHECK_API_ENDPOINT=/health
HEALTHCHECK_API_CMD='["CMD", "curl", "-f", "http://localhost:${PORT_API_INTERNAL}/health"]'
HEALTHCHECK_FRONTEND_CMD='["CMD", "curl", "-f", "http://localhost/health.html"]'

# Health Check Intervals
HEALTHCHECK_INTERVAL=30s
HEALTHCHECK_TIMEOUT=10s
HEALTHCHECK_RETRIES=3
HEALTHCHECK_START_PERIOD=30s

# Startup delays (for service ordering)
STARTUP_DELAY_DB=0
STARTUP_DELAY_REDIS=0
STARTUP_DELAY_API=10
STARTUP_DELAY_FRONTEND=5

# -----------------------------------------------------------------------------
# SERVICE DEPENDENCIES (startup order)
# -----------------------------------------------------------------------------
# Format: service -> depends_on
# Level 0: No dependencies (databases)
# Level 1: Depends on databases (api, cache)
# Level 2: Depends on api (frontend)

DEPENDENCY_ORDER_L0="${CONTAINER_MARIADB},${CONTAINER_REDIS}"
DEPENDENCY_ORDER_L1="${CONTAINER_API}"
DEPENDENCY_ORDER_L2="${CONTAINER_FRONTEND}"

# Full startup sequence
STARTUP_SEQUENCE="${CONTAINER_MARIADB},${CONTAINER_REDIS},${CONTAINER_API},${CONTAINER_FRONTEND}"

# -----------------------------------------------------------------------------
# VOLUME NAMING CONVENTION
# Format: {project}_{service}_data
# -----------------------------------------------------------------------------
VOLUME_DB_DATA=crm_db_data
VOLUME_API_DATA=crm_api_data
VOLUME_REDIS_DATA=crm_redis_data
VOLUME_CONTRACTS=crm_contracts

# -----------------------------------------------------------------------------
# KUBERNETES CONFIGURATION
# -----------------------------------------------------------------------------
K8S_NAMESPACE=${PROJECT_NAMESPACE}
K8S_REGISTRY=${BUILD_SERVER}:5000

# Deployment Names
K8S_DEPLOY_API=crm-api
K8S_DEPLOY_FRONTEND=crm-frontend
K8S_DEPLOY_DB=crm-db

# Service Names
K8S_SVC_API=crm-api-service
K8S_SVC_FRONTEND=crm-frontend-service
K8S_SVC_DB=crm-db-service

# ConfigMap/Secret Names
K8S_CONFIGMAP=crm-config
K8S_SECRET=crm-secrets

# Ingress
K8S_INGRESS=crm-ingress
K8S_INGRESS_CLASS=nginx

# -----------------------------------------------------------------------------
# JWT CONFIGURATION
# -----------------------------------------------------------------------------
JWT_SECRET=${JWT_SECRET:-CrmJwtSecretKey2024ForSecureAuthentication}
JWT_ISSUER=${JWT_ISSUER:-CRMApp}
JWT_AUDIENCE=${JWT_AUDIENCE:-CRMUsers}
JWT_EXPIRATION_MINUTES=${JWT_EXPIRATION_MINUTES:-15}

# -----------------------------------------------------------------------------
# LLM CONFIGURATION (Ollama Local)
# -----------------------------------------------------------------------------
LLM_PROVIDER=local
LLM_BASE_URL=http://host.docker.internal:11434
LLM_DEFAULT_MODEL=qwen2.5:0.5b
LLM_API_FORMAT=ollama

# -----------------------------------------------------------------------------
# FRONTEND CONFIGURATION
# -----------------------------------------------------------------------------
FRONTEND_URL=${FRONTEND_URL:-http://localhost}
FRONTEND_API_URL=${FRONTEND_API_URL:-http://localhost:5000}

# -----------------------------------------------------------------------------
# MONITORING & LOGGING
# -----------------------------------------------------------------------------
DEPLOYMENT_TYPE=${DEPLOYMENT_TYPE:-docker}
ENABLE_DOCKER_MONITORING=true
ENABLE_K8S_MONITORING=false
LOG_LEVEL=${LOG_LEVEL:-Information}

# -----------------------------------------------------------------------------
# BUILD CONFIGURATION
# -----------------------------------------------------------------------------
DOTNET_VERSION=8.0
NODE_VERSION=20
NPM_VERSION=10

# Build paths on remote server
REMOTE_SOURCE_PATH=/opt/crm/source
REMOTE_BUILD_PATH=/opt/crm/build
REMOTE_DEPLOY_PATH=/opt/crm/deploy

# Local paths
LOCAL_DOCKER_PATH=docker
LOCAL_K8S_PATH=kubernetes
LOCAL_SCRIPTS_PATH=scripts
LOCAL_CONFIG_PATH=config

# -----------------------------------------------------------------------------
# MONITORING SERVICES CONFIGURATION
# -----------------------------------------------------------------------------
# Uptime Kuma - Service health monitoring
CONTAINER_UPTIME_KUMA=uptime-kuma
PORT_UPTIME_KUMA=3001
UPTIME_KUMA_ADMIN_USER=${UPTIME_KUMA_ADMIN_USER:-admin}
UPTIME_KUMA_ADMIN_PASS=${UPTIME_KUMA_ADMIN_PASS:-CrmAdmin2024!}

# Portainer - Container management
CONTAINER_PORTAINER=portainer
PORT_PORTAINER=9000
PORT_PORTAINER_AGENT=9443
PORTAINER_ADMIN_USER=${PORTAINER_ADMIN_USER:-admin}
PORTAINER_ADMIN_PASS=${PORTAINER_ADMIN_PASS:-CrmAdmin2024!}

# Monitoring URLs (based on build server)
MONITORING_UPTIME_KUMA_URL=http://${BUILD_SERVER}:${PORT_UPTIME_KUMA}
MONITORING_PORTAINER_URL=http://${BUILD_SERVER}:${PORT_PORTAINER}

# Enable/disable monitoring services
ENABLE_MONITORING=${ENABLE_MONITORING:-true}
ENABLE_UPTIME_KUMA=${ENABLE_UPTIME_KUMA:-true}
ENABLE_PORTAINER=${ENABLE_PORTAINER:-true}

# -----------------------------------------------------------------------------
# FILE STORAGE CONFIGURATION
# -----------------------------------------------------------------------------
CONTRACT_STORAGE_PATH=/app/data/contracts
MAX_CONTRACT_FILE_SIZE=10485760
ALLOWED_MIME_TYPES=application/pdf,image/png,image/jpeg,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document

# -----------------------------------------------------------------------------
# HELPER FUNCTIONS (for shell scripts)
# -----------------------------------------------------------------------------
# These can be sourced in scripts for consistent behavior

# Get container name based on architecture
# Usage: get_container_name "api"
get_container_name() {
    local service=$1
    if [ "$ARCHITECTURE_MODE" = "microservices" ]; then
        case $service in
            db) echo "$MS_CONTAINER_DB" ;;
            gateway) echo "$MS_CONTAINER_GATEWAY" ;;
            identity) echo "$MS_CONTAINER_IDENTITY" ;;
            customer) echo "$MS_CONTAINER_CUSTOMER" ;;
            sales) echo "$MS_CONTAINER_SALES" ;;
            marketing) echo "$MS_CONTAINER_MARKETING" ;;
            servicedesk) echo "$MS_CONTAINER_SERVICEDESK" ;;
            core) echo "$MS_CONTAINER_CORE" ;;
            *) echo "crm-$service" ;;
        esac
    else
        case $service in
            db|mariadb) echo "$CONTAINER_MARIADB" ;;
            redis) echo "$CONTAINER_REDIS" ;;
            api) echo "$CONTAINER_API" ;;
            frontend) echo "$CONTAINER_FRONTEND" ;;
            *) echo "crm-$service" ;;
        esac
    fi
}

# Get image name with registry
# Usage: get_image_name "api" "v1.2.3"
get_image_name() {
    local service=$1
    local version=${2:-latest}
    echo "${IMAGE_REGISTRY}/crm-${service}:${version}"
}

# Get connection string based on database provider
# Usage: get_connection_string
get_connection_string() {
    if [ "$DATABASE_PROVIDER" = "mariadb" ]; then
        echo "$MARIADB_CONNECTION_STRING"
    else
        echo "$MSSQL_CONNECTION_STRING"
    fi
}
