volumes:
  db-data:
  api-data:
services:
  # Database Tier (MariaDB)
  mariadb:
    image: mariadb:latest
    container_name: crm-mariadb
    ports:
      - "${DB_EXTERNAL_PORT:-3306}:3306"
    environment:
      - MARIADB_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-RootPass@Dev2024}
      - MARIADB_DATABASE=${DB_NAME:-crm_db}
      - MARIADB_USER=${DB_USER:-crm_user}
      - MARIADB_PASSWORD=${DB_PASSWORD:-CrmPass@Dev2024}
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - crm-network

    # healthcheck:
    #   test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5

  # API Tier (Application/Business Logic)
  api:
    build:
      context: .
      dockerfile: Dockerfile.backend
    image: crm-api:latest
    container_name: crm-api
    ports:
      - "${API_EXTERNAL_PORT:-5000}:5000"
    env_file:
      - .env
    environment:
      - DatabaseProvider=mariadb
      - DB_HOST=mariadb
      - DB_PORT=${DB_INTERNAL_PORT:-3306}
      - DB_NAME=${DB_NAME:-crm_db}
      - DB_USER=${DB_USER:-crm_user}
      - DB_PASSWORD=${DB_PASSWORD}
      # Default connection string constructed from DB envs (used by the API)
      - ConnectionStrings__DefaultConnection=Server=${DB_HOST:-mariadb};Port=${DB_PORT:-3306};Database=${DB_NAME:-crm_db};User=${DB_USER:-crm_user};Password=${DB_PASSWORD:-CrmPass@Dev2024};
      - API_EXTERNAL_PORT=${API_EXTERNAL_PORT:-5000}
      - API_INTERNAL_PORT=5000
      - Jwt__ExpirationMinutes=15
      # Contract storage configuration
      - CONTRACT_STORAGE_PATH=/app/data/contracts
      - MAX_CONTRACT_FILE_SIZE_BYTES=10485760
      - ALLOWED_CONTRACT_MIME_TYPES=application/pdf,image/png,image/jpeg,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document
    volumes:
      - api-data:/app/data
    # depends_on:
    #   mariadb:
    #     condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - crm-network

  # Frontend Tier (Presentation)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        BUILD_DATE: "2026-01-20T12:00:00Z"
        REACT_APP_API_URL: ${REACT_APP_API_URL}
        REACT_APP_API_PORT: ${API_INTERNAL_PORT:-5000}
        REACT_APP_API_EXTERNAL_PORT: ${API_EXTERNAL_PORT:-5000}
        REACT_APP_DB_PORT: ${DB_INTERNAL_PORT:-3306}
        REACT_APP_FRONTEND_PORT: ${FRONTEND_EXTERNAL_PORT:-3000}
    # image: crm-frontend:latest
    container_name: crm-frontend
    ports:
      - "${FRONTEND_EXTERNAL_PORT:-3000}:3000"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
    depends_on:
      - api
    networks:
      - crm-network

networks:
  crm-network:
    driver: bridge
